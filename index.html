<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EFS - GÃ©nÃ©rateur de Badge</title>
    <style>
        /* --- CONFIGURATION DES COULEURS --- */
        :root {
            --primary-blue: #009de0; 
            --action-red: #e13a34;   
            --success-green: #10b981; 
            --bg-white: #ffffff;
            --text-dark: #1a202c;
            --text-gray: #718096;
            --border-light: #e2e8f0;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background-color: var(--bg-white);
            color: var(--text-dark);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px 20px;
            min-height: 100vh;
        }

        h1 { font-size: 2.2rem; margin-bottom: 10px; font-weight: 800; text-align: center; }
        h1 span { color: var(--action-red); }
        .description { color: var(--text-gray); margin-bottom: 40px; max-width: 500px; text-align: center; font-size: 1.1rem; }

        /* --- STEPPER --- */
        .stepper { display: flex; align-items: center; justify-content: center; margin-bottom: 40px; width: 100%; max-width: 450px; }
        .step-item { display: flex; flex-direction: column; align-items: center; width: 80px; }
        .step-circle {
            width: 35px; height: 35px; border-radius: 50%; background: #edf2f7; color: var(--text-gray);
            display: flex; align-items: center; justify-content: center; font-weight: 700; transition: background 0.3s;
        }
        .step-label { font-size: 0.75rem; font-weight: 600; color: var(--text-gray); margin-top: 8px; }
        .step-circle.active { background: var(--primary-blue); color: white; }
        .step-label.active { color: var(--primary-blue); }
        .step-circle.completed { background: var(--success-green); color: white; }
        .line { flex-grow: 1; height: 2px; background: #edf2f7; position: relative; top: -12px; }
        .line.completed { background: var(--success-green); }

        /* --- CARTE --- */
        .card {
            background: white; width: 100%; max-width: 550px; padding: 40px; border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05); border: 1px solid var(--border-light); text-align: center;
        }
        .icon-box {
            width: 60px; height: 60px; background: var(--primary-blue); border-radius: 50%;
            display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;
            color: white; font-size: 1.5rem;
        }

        /* --- ZONE UPLOAD & APERÃ‡U --- */
        .upload-area {
            border: 2px dashed var(--primary-blue); border-radius: 8px; padding: 30px 20px;
            cursor: pointer; transition: all 0.2s ease; background: #f0f9ff; margin-bottom: 25px;
        }
        .upload-area.dragover { background: #e0f2fe; border-style: solid; transform: scale(1.02); }
        .upload-icon { font-size: 2rem; margin-bottom: 10px; display: block; color: var(--primary-blue); pointer-events: none; }
        
        #previewContainer {
            display: none;
            flex-direction: column;
            align-items: center;
            margin-bottom: 25px;
            animation: fadeIn 0.4s ease;
        }
        #imagePreview {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--primary-blue);
            margin-bottom: 10px;
        }
        #fileNameDisplay { color: var(--primary-blue); font-weight: 600; font-size: 0.9rem; }

        /* --- BOUTONS & INPUTS --- */
        button {
            width: 100%; padding: 16px; background-color: var(--action-red); color: white;
            border: none; border-radius: 6px; font-size: 1rem; font-weight: 700; cursor: pointer;
            text-transform: uppercase; letter-spacing: 0.5px; transition: opacity 0.2s;
        }
        button:hover { opacity: 0.9; }

        input[type="text"] {
            width: 100%; padding: 15px; border: 1px solid var(--border-light); border-radius: 6px;
            font-size: 1rem; margin-bottom: 20px; text-align: center; box-sizing: border-box;
        }

        canvas { border-radius: 50%; border: 4px solid #eee; max-width: 100%; height: auto; margin-bottom: 20px; display: none; margin-left: auto; margin-right: auto; }
        .error-msg { color: var(--action-red); font-weight: 600; margin-bottom: 15px; display: none; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <h1>Badge donneur de <span>sang</span></h1>
    <p class="description">Validez votre identifiant et personnalisez votre photo pour crÃ©er votre badge.</p>

    <div class="stepper">
        <div class="step-item">
            <div class="step-circle active" id="circle1">1</div>
            <div class="step-label active">Identifiant</div>
        </div>
        <div class="line" id="line1"></div>
        <div class="step-item">
            <div class="step-circle" id="circle2">2</div>
            <div class="step-label" id="label2">Photo</div>
        </div>
        <div class="line" id="line2"></div>
        <div class="step-item">
            <div class="step-circle" id="circle3">3</div>
            <div class="step-label" id="label3">Badge</div>
        </div>
    </div>

    <div class="card">
        <div id="step1">
            <div class="icon-box">âœ“</div>
            <h2>Identification</h2>
            <p>Saisissez votre code (ex: A-123456)</p>
            <input type="text" id="donorId" placeholder="Code donneur">
            <div id="error" class="error-msg">Identifiant incorrect</div>
            <button onclick="checkId()">Valider</button>
        </div>

        <div id="step2" style="display: none;">
            <div class="icon-box">ðŸ“·</div>
            <h2>Votre photo</h2>
            <p>Niveau <strong id="lvlTxt"></strong> sÃ©lectionnÃ©. Importez votre photo.</p>
            
            <div class="upload-area" id="dropZone">
                <span class="upload-icon">ðŸ“·</span>
                <strong>Glissez votre photo ici</strong><br>
                <span style="font-size: 0.8rem; color: var(--text-gray);">ou cliquez pour choisir</span>
            </div>
            <input type="file" id="photoUpload" accept="image/*" style="display: none;">

            <div id="previewContainer">
                <img id="imagePreview" src="" alt="AperÃ§u">
                <div id="fileNameDisplay"></div>
            </div>

            <button onclick="processBadge()">GÃ©nÃ©rer mon badge</button>
        </div>

        <div id="step3" style="display: none;">
            <h2>Badge prÃªt !</h2>
            <p>Votre photo de profil est prÃªte Ã  Ãªtre tÃ©lÃ©chargÃ©e.</p>
            <canvas id="badgeCanvas" width="400" height="400"></canvas>
            <button onclick="downloadImage()">TÃ©lÃ©charger l'image</button>
        </div>
    </div>

    <script>
        let currentLevel = 0;
        let selectedFile = null;
        const canvas = document.getElementById('badgeCanvas');
        const ctx = canvas.getContext('2d');
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('photoUpload');
        const previewContainer = document.getElementById('previewContainer');
        const imagePreview = document.getElementById('imagePreview');
        const fileNameDisplay = document.getElementById('fileNameDisplay');

        /* --- DRAG & DROP LOGIC --- */
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); }, false);
        });
        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.add('dragover'), false);
        });
        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.remove('dragover'), false);
        });
        dropZone.addEventListener('drop', (e) => { handleFiles(e.dataTransfer.files); });
        dropZone.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', function() { handleFiles(this.files); });

        function handleFiles(files) {
            if (files.length > 0) {
                selectedFile = files[0];
                fileNameDisplay.textContent = "Photo : " + selectedFile.name;
                const reader = new FileReader();
                reader.onload = (e) => {
                    imagePreview.src = e.target.result;
                    previewContainer.style.display = 'flex';
                }
                reader.readAsDataURL(selectedFile);
            }
        }

        /* --- ETAPE 1 : VALIDATION --- */
        function checkId() {
            const val = document.getElementById('donorId').value.trim().toUpperCase();
            if (val === 'A-123456' || val.includes('NIVEAU1')) currentLevel = 1;
            else if (val === 'B-987654' || val.includes('NIVEAU2')) currentLevel = 2;
            else if (val === 'C-112233' || val.includes('NIVEAU3')) currentLevel = 3;
            else currentLevel = 0;

            if (currentLevel > 0) {
                document.getElementById('step1').style.display = 'none';
                document.getElementById('step2').style.display = 'block';
                document.getElementById('lvlTxt').textContent = currentLevel;
                updateStepper(1);
            } else {
                document.getElementById('error').style.display = 'block';
            }
        }

        /* --- ETAPE 2 : GÃ‰NÃ‰RATION DU BADGE --- */
        function processBadge() {
            if (!selectedFile) return alert("Merci d'ajouter une photo.");

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const ornement = new Image();
                    ornement.onload = function() {
                        canvas.style.display = 'block';
                        ctx.clearRect(0, 0, 400, 400);
                        
                        // 1. Dessiner la photo avec recadrage central (Cover)
                        ctx.save();
                        ctx.beginPath();
                        ctx.arc(200, 200, 200, 0, Math.PI * 2);
                        ctx.clip();
                        
                        let ratio = Math.max(400 / img.width, 400 / img.height);
                        let nw = img.width * ratio;
                        let nh = img.height * ratio;
                        ctx.drawImage(img, (400 - nw) / 2, (400 - nh) / 2, nw, nh);
                        ctx.restore();

                        // 2. Dessiner l'ornement par-dessus
                        ctx.drawImage(ornement, 0, 0, 400, 400);
                        
                        document.getElementById('step2').style.display = 'none';
                        document.getElementById('step3').style.display = 'block';
                        updateStepper(2);
                    };
                    ornement.onerror = () => alert("Fichier ornement_niveau" + currentLevel + ".png introuvable !");
                    ornement.src = `ornement_niveau${currentLevel}.png`;
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(selectedFile);
        }

        function updateStepper(step) {
            if (step === 1) {
                document.getElementById('circle1').classList.remove('active');
                document.getElementById('circle1').classList.add('completed');
                document.getElementById('circle1').innerHTML = 'âœ“';
                document.getElementById('line1').classList.add('completed');
                document.getElementById('circle2').classList.add('active');
                document.getElementById('label2').classList.add('active');
            } else if (step === 2) {
                document.getElementById('circle2').classList.remove('active');
                document.getElementById('circle2').classList.add('completed');
                document.getElementById('circle2').innerHTML = 'âœ“';
                document.getElementById('line2').classList.add('completed');
                document.getElementById('circle3').classList.add('active');
                document.getElementById('label3').classList.add('active');
            }
        }

        function downloadImage() {
            const link = document.createElement('a');
            link.download = `mon-badge-niveau${currentLevel}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        }
    </script>
</body>
</html>
